generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  phone        String?
  passwordHash String
  role         UserRole  @default(CUSTOMER)
  emailVerifiedAt DateTime?
  verificationToken String? @unique
  resetPasswordToken String? @unique
  resetPasswordExpires DateTime?
  projects     Project[]
  technicianTrips Trip[] @relation("TechnicianTrips")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Project {
  id          String             @id @default(cuid())
  user        User               @relation(fields: [userId], references: [id])
  userId      String
  name        String
  status      ProjectStatus      @default(ONBOARDING)
  buildingType String?
  roomsCount  Int?
  onboarding  OnboardingSession?
  trips       Trip[]
  quotes      Quote[]
  agreements  ProjectAgreement[] @relation("ProjectAgreements")
  paymentPlan PaymentPlan?       @relation("ProjectPaymentPlan")
  milestones  ProjectMilestone[] @relation("ProjectMilestones")
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model OnboardingSession {
  id               String   @id @default(cuid())
  project          Project  @relation(fields: [projectId], references: [id])
  projectId        String   @unique
  projectStatus    String?
  constructionStage String?
  needsInspection  Boolean? @default(false)
  selectedFeatures Json?
  stairSteps       Int?
  siteAddress      String?
  contactPhone     String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Product {
  id           String        @id @default(cuid())
  name         String
  category     ProductCategory
  priceTier    PriceTier
  unitPrice    Decimal
  marketPrice  Decimal?
  ourPrice     Decimal?
  description  String?
  imageUrl     String?
  videoUrl     String?
  active       Boolean       @default(true)
  quoteItems   QuoteItem[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Trip {
  id            String        @id @default(cuid())
  project       Project       @relation(fields: [projectId], references: [id])
  projectId     String
  milestone     ProjectMilestone? @relation(fields: [milestoneId], references: [id])
  milestoneId   String?
  technician    User?         @relation("TechnicianTrips", fields: [technicianId], references: [id])
  technicianId  String?
  status        TripStatus    @default(SCHEDULED)
  scheduledFor  DateTime
  checkInAt     DateTime?
  checkOutAt    DateTime?
  notes         String?
  reworkReason  String?
  reworkRequestedAt DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  tasks         TripTask[]
  photos        TripPhoto[]
}

model Quote {
  id          String       @id @default(cuid())
  project     Project      @relation(fields: [projectId], references: [id])
  projectId   String
  tier        PriceTier
  status      QuoteStatus  @default(GENERATED)
  title       String?
  currency    String       @default("NGN")
  subtotal    Decimal
  installationFee Decimal  @default(0)
  integrationFee  Decimal  @default(0)
  logisticsCost   Decimal  @default(0)
  miscellaneousFee Decimal @default(0)
  taxAmount      Decimal   @default(0)
  total       Decimal
  isSelected  Boolean      @default(false)
  items       QuoteItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model QuoteItem {
  id          String         @id @default(cuid())
  quote       Quote          @relation(fields: [quoteId], references: [id])
  quoteId     String
  product     Product?       @relation(fields: [productId], references: [id])
  productId   String?
  name        String
  category    ProductCategory
  quantity    Int
  unitPrice   Decimal
  totalPrice  Decimal
  notes       String?
}

model ProjectAgreement {
  id                     String          @id @default(cuid())
  project                Project         @relation("ProjectAgreements", fields: [projectId], references: [id])
  projectId              String
  type                   AgreementType
  title                  String
  content                String
  acceptedAt             DateTime?
  acceptedByUserId       String?
  acceptedDeviceSignature String?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
}

model PaymentPlan {
  id         String           @id @default(cuid())
  project    Project          @relation("ProjectPaymentPlan", fields: [projectId], references: [id])
  projectId  String           @unique
  type       PaymentPlanType
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

model ProjectMilestone {
  id          String           @id @default(cuid())
  project     Project          @relation("ProjectMilestones", fields: [projectId], references: [id])
  projectId   String
  planType    PaymentPlanType
  index       Int
  title       String
  description String?
  percentage  Int
  amount      Decimal
  itemsJson   Json
  status      MilestoneStatus  @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  trips       Trip[]
}

model TripTask {
  id        String   @id @default(cuid())
  trip      Trip     @relation(fields: [tripId], references: [id])
  tripId    String
  label     String
  sequence  Int
  isDone    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TripPhoto {
  id        String   @id @default(cuid())
  trip      Trip     @relation(fields: [tripId], references: [id])
  tripId    String
  url       String
  caption   String?
  createdAt DateTime @default(now())
}

enum UserRole {
  CUSTOMER
  TECHNICIAN
  ADMIN
}

enum ProjectStatus {
  ONBOARDING
  INSPECTION_REQUESTED
  INSPECTION_SCHEDULED
  INSPECTION_COMPLETED
  QUOTES_GENERATED
  QUOTE_SELECTED
  DOCUMENTS_PENDING
  DOCUMENTS_SIGNED
  PAYMENT_PLAN_SELECTED
  IN_PROGRESS
  COMPLETED
}

enum ProductCategory {
  LIGHTING
  CLIMATE
  ACCESS
  SURVEILLANCE
  GATE
  STAIRCASE
}

enum PriceTier {
  ECONOMY
  STANDARD
  LUXURY
}

enum TripStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum QuoteStatus {
  GENERATED
  CUSTOMER_EDITED
  SELECTED
}

enum AgreementType {
  MAINTENANCE
  SCOPE_OF_WORK
  PAYMENT_TERMS
}

enum PaymentPlanType {
  MILESTONE_3
  EIGHTY_TEN_TEN
}

enum MilestoneStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
}
